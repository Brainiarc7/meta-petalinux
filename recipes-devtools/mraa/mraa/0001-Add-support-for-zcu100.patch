From fad9a1d0d6e366668038ee40e3b7945fca9832d6 Mon Sep 17 00:00:00 2001
From: Manjukumar Matha <manjukumar.harthikote-matha@xilinx.com>
Date: Wed, 7 Jun 2017 16:24:03 -0700
Subject: [PATCH] Add support for zcu100

Signed-off-by: Michal Simek <michal.simek@xilinx.com>
Signed-off-by: Peter Ryser <peter.ryser@xilinx.com> 
Signed-off-by: Manjukumar Matha <manjukumar.harthikote-matha@xilinx.com>
Upstream-status: Pending
---
 src/arm/96boards.c | 29 ++++++++++++++++++++++++++++-
 src/arm/arm.c      |  2 ++
 2 files changed, 30 insertions(+), 1 deletion(-)

diff --git a/src/arm/96boards.c b/src/arm/96boards.c
index a0afc68..2959638 100644
--- a/src/arm/96boards.c
+++ b/src/arm/96boards.c
@@ -38,6 +38,7 @@
 
 #define PLATFORM_NAME_DB410C "DB410C"
 #define PLATFORM_NAME_HIKEY "HIKEY"
+#define PLATFORM_NAME_ZCU100 "ZCU100"
 #define PLATFORM_NAME_BBGUM "BBGUM"
 
 int db410c_ls_gpio_pins[MRAA_96BOARDS_LS_GPIO_COUNT] = {
@@ -53,6 +54,18 @@ int hikey_ls_gpio_pins[MRAA_96BOARDS_LS_GPIO_COUNT] = {
 
 const char* hikey_serialdev[MRAA_96BOARDS_LS_UART_COUNT] = { "/dev/ttyAMA2", "/dev/ttyAMA3" };
 
+/* PS GPIO 332 + 36 37 39 40 44 45
+ * And then there are 4 gpios which needs to go from PL
+ * currently label them as
+ * 511 510 509 508
+*/
+int zcu100_ls_gpio_pins[MRAA_96BOARDS_LS_GPIO_COUNT] = {
+ 368, 369, 371, 372, 376, 377, 511, 510, 509, 508, 507, 506
+};
+
+const char* zcu100_serialdev[MRAA_96BOARDS_LS_UART_COUNT] = { "/dev/tty96B0", "/dev/tty96B1"};
+
+
 int bbgum_ls_gpio_pins[MRAA_96BOARDS_LS_GPIO_COUNT] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 155, 154 };
 
 const char* bbgum_serialdev[MRAA_96BOARDS_LS_UART_COUNT] = { "/dev/ttyS3", "/dev/ttyS5" };
@@ -104,6 +117,11 @@ mraa_96boards()
             ls_gpio_pins = hikey_ls_gpio_pins;
             b->uart_dev[0].device_path = hikey_serialdev[0];
             b->uart_dev[1].device_path = hikey_serialdev[1];
+        } else if (mraa_file_contains(DT_BASE "/model", "ZynqMP ZCU100")) {
+            b->platform_name = PLATFORM_NAME_ZCU100;
+            ls_gpio_pins = zcu100_ls_gpio_pins;
+            b->uart_dev[0].device_path = zcu100_serialdev[0];
+            b->uart_dev[1].device_path = zcu100_serialdev[1];
         } else if (mraa_file_contains(DT_BASE "/model", "s900")) {
             b->platform_name = PLATFORM_NAME_BBGUM;
             ls_gpio_pins = bbgum_ls_gpio_pins;
@@ -117,7 +135,16 @@ mraa_96boards()
     b->def_uart_dev = 0;
 
     // I2C
-    if (b->platform_name == PLATFORM_NAME_BBGUM) {
+    if (b->platform_name == PLATFORM_NAME_ZCU100) {
+      /*
+       * ZCU100 has i2c mux on i2c1 which means that first bus is i2c-2
+       * and second i2c-3
+       */
+      b->i2c_bus_count = MRAA_96BOARDS_LS_I2C_COUNT;
+      b->def_i2c_bus = 0;
+      b->i2c_bus[0].bus_id = 2;
+      b->i2c_bus[1].bus_id = 3;
+    } else if (b->platform_name == PLATFORM_NAME_BBGUM) {
         b->i2c_bus_count = MRAA_96BOARDS_LS_I2C_COUNT;
         b->def_i2c_bus = 0;
         b->i2c_bus[0].bus_id = 1;
diff --git a/src/arm/arm.c b/src/arm/arm.c
index 40eccf5..f834058 100644
--- a/src/arm/arm.c
+++ b/src/arm/arm.c
@@ -90,6 +90,8 @@ mraa_arm_platform()
         else if (mraa_file_contains("/proc/device-tree/model",
                                     "HiKey Development Board"))
             platform_type = MRAA_96BOARDS;
+        else if (mraa_file_contains("/sys/firmware/devicetree/base/model", "ZynqMP ZCU100"))
+            platform_type = MRAA_96BOARDS;
         else if (mraa_file_contains("/proc/device-tree/model", "s900"))
             platform_type = MRAA_96BOARDS;
         else if (mraa_file_contains("/proc/device-tree/compatible", "raspberrypi,"))
-- 
2.7.4

